import { Component, Emit, Vue } from "vue-property-decorator";
import { IArticleData } from "@/api/types";
import Pagination from "@/components/Pagination/index.vue";
import MainSubLayout from "@/components/CollpaseFlex/index.vue";
import ProTable from "@/components/Table/index.vue";
import EquipmentClassTree from "./equipmentClassTree.vue";
import {
  getPageviews,
  createArticle,
  updateArticle,
  defaultArticleData
} from "@/api/articles";
import { Form } from "element-ui";
import { cloneDeep } from "lodash";
import router from "@/router";

const calendarTypeOptions = [
  { key: "CN", displayName: "China" },
  { key: "US", displayName: "USA" },
  { key: "JP", displayName: "Japan" },
  { key: "EU", displayName: "Eurozone" }
];

// arr to obj, such as { CN : "China", US : "USA" }
const calendarTypeKeyValue = calendarTypeOptions.reduce(
  (
    acc: {
      [key: string]: string;
    },
    cur
  ) => {
    acc[cur.key] = cur.displayName;
    return acc;
  },
  {}
) as {
  [key: string]: string;
};

@Component({
  name: "EquipmentCategory",
  components: {
    Pagination,
    MainSubLayout,
    ProTable,
    EquipmentClassTree
  },
  filters: {
    typeFilter: (type: string) => {
      return calendarTypeKeyValue[type];
    }
  }
})
export default class extends Vue {
  public columns = [
    {
      width: 120,
      dataIndex: "timestamp",
      title: "äº§å“æ‰¹å·"
    },
    {
      width: 120,
      dataIndex: "timestamp",
      title: "è®¾å¤‡åç§°"
    },
    {
      width: 120,
      dataIndex: "author",
      title: "ç§‘å®¤"
    },
    {
      width: 120,
      dataIndex: "reviewer",
      title: "è®¾å¤‡åž‹å·"
    },
    {
      width: 120,
      dataIndex: "reviewer",
      title: "å“ç‰Œ"
    },
    {
      width: 120,
      dataIndex: "reviewer",
      title: "äº§åœ°"
    },
    {
      width: 120,
      dataIndex: "author",
      title: "è®¾å¤‡ç±»åˆ«"
    },
    {
      width: 120,
      dataIndex: "author",
      title: "çŠ¶æ€"
    },
    {
      width: 120,
      dataIndex: "author",
      title: "è®¾å¤‡ä»·æ ¼"
    },
    {
      width: 120,
      dataIndex: "author",
      title: "å¯ç”¨æ—¶é—´"
    },
    {
      width: 120,
      dataIndex: "author",
      title: "ç”Ÿäº§æ—¥æœŸ"
    },
    {
      width: 120,
      dataIndex: "author",
      title: "ä¿è´¨æœŸ(å¹´)"
    },
    {
      width: 120,
      dataIndex: "author",
      title: "æ·»åŠ æ—¶é—´"
    },
    {
      width: 200,
      dataIndex: "type",
      title: "æ“ä½œ"
    }
  ]; //è¡¨æ ¼åˆ—è®¾ç½®
  public formList = [
    {
      label: "äº§å“æ‰¹å·",
      value: "user"
    },
    {
      label: "è®¾å¤‡åç§°",
      value: "region"
    },
    {
      label: "ç§‘å®¤",
      value: "user"
    },
    {
      label: "çŠ¶æ€",
      value: "user"
    },
    {
      label: "è®¾å¤‡åž‹å·",
      value: "user"
    },
    {
      label: "è®¾å¤‡ç±»åˆ«",
      value: "user"
    }
  ]; //è¡¨æ ¼è¡¨å•æŸ¥è¯¢é¡¹
  private dialogStatus = "";
  public dialogFormVisible = false; //æ–°å¢žæ¨¡æ€æ¡†æ˜¾éš
  private tempArticleData = defaultArticleData; //é»˜è®¤æ–°å¢žæ¨¡æ€æ¡†æ•°æ®
  private showReviewer = false;
  // æ–°å¢žè®¾å¤‡ç±»åˆ«
  public addNewEquipmentClass = () => {};
  private textMap = {
    update: "ç¼–è¾‘",
    create: "æ·»åŠ "
  };
  private statusOptions = ["published", "draft", "deleted"];
  private list: any = [];
  private rules = {
    type: [{ required: true, message: "type is required", trigger: "change" }],
    timestamp: [
      { required: true, message: "timestamp is required", trigger: "change" }
    ],
    title: [{ required: true, message: "title is required", trigger: "blur" }]
  };
  private dialogPageviewsVisible = false;
  private pageviewsData = [];
  mounted() {
    console.log(this.dialogFormVisible);
  }
  private createData() {
    (this.$refs.dataForm as Form).validate(async valid => {
      if (valid) {
        const articleData = this.tempArticleData;
        articleData.id = Math.round(Math.random() * 100) + 1024; // mock a id
        articleData.author = "vue-typescript-admin";
        const { data } = await createArticle({ article: articleData });
        data.article.timestamp = Date.parse(data.article.timestamp);
        this.list.unshift(data.article);
        this.dialogFormVisible = false;
        this.$notify({
          title: "æˆåŠŸ",
          message: "åˆ›å»ºæˆåŠŸ",
          type: "success",
          duration: 2000
        });
      }
    });
  }

  private handleUpdate(row: any) {
    this.tempArticleData = Object.assign({}, row);
    this.tempArticleData.timestamp = +new Date(this.tempArticleData.timestamp);
    this.dialogStatus = "update";
    this.dialogFormVisible = true;
    this.$nextTick(() => {
      (this.$refs.dataForm as Form).clearValidate();
    });
  }

  private updateData() {
    (this.$refs.dataForm as Form).validate(async valid => {
      if (valid) {
        const tempData = Object.assign({}, this.tempArticleData);
        tempData.timestamp = +new Date(tempData.timestamp); // change Thu Nov 30 2017 16:41:05 GMT+0800 (CST) to 1512031311464
        const { data } = await updateArticle(tempData.id, {
          article: tempData
        });
        const index = this.list.findIndex((v: any) => v.id === data.article.id);
        this.list.splice(index, 1, data.article);
        this.dialogFormVisible = false;
        this.$notify({
          title: "æˆåŠŸ",
          message: "æ›´æ–°æˆåŠŸ",
          type: "success",
          duration: 2000
        });
      }
    });
  }

  private resetTempArticleData() {
    this.tempArticleData = cloneDeep(defaultArticleData);
  }

  private async handleGetPageviews(pageviews: string) {
    const { data } = await getPageviews({ pageviews });
    this.pageviewsData = data.pageviews;
    this.dialogPageviewsVisible = true;
  }
  @Emit()
  emitHandleCreate() {
    // this.resetTempArticleData();
    // this.dialogStatus = "create";
    // console.log("ðŸš€ ~ dialogStatus", this.dialogStatus);
    // this.dialogFormVisible = true;
    // this.$nextTick(() => {
    //   (this.$refs.dataForm as Form).clearValidate();
    // });
    this.$router.push({ path: "/equipmentArchives/addNewEquipment" });
  }
}
